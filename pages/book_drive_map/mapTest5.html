<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCjjILLNwtXHcFQmQaoroOtZvWKGg7sHS0&libraries=places,geocoding" async defer></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

    
</head>
<body onload="initMap()">
    <h1 class="text-center">Direction route finder</h1>
    <br><br>
    <div class="container">
        <div class="form-group">
            <h2>Source location:</h2>
            <input type="text" class="form-control" placeholder="Source Location" id="source" >
        </div>
        <div class="form-group">
            <h2>Nearest bookdrive:</h2>
            <input type="text" class="form-control" placeholder="Destination Location" id="destination">
        </div>


        <button class="btn btn-primary" onclick="calRoute()">Get Direction</button>
        <div id="map" style="height:500px;width:100%;"></div>
    </div>



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
  
</body>


<script>
let map,directionsService,directionsRenderer;
let sourceAutocomplete,desAutocomplete
let marker; 



const bookstores = [
  {
    name: "Times Waterway Point",
    location: { lat: 1.4090056338031878, lng: 103.90208909688073 },
  },
   
  {
    name: "Evernew Book Store",
    location: { lat: 1.303622146427246, lng: 103.85340253923619 },
  },
  // Add more bookstores with their respective locations
];


function initMap(){

 
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
            const { latitude, longitude } = position.coords;
            //store user current location coords
            
            const latLng = new google.maps.LatLng(latitude, longitude);
            

            const userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
              };

              

                // Find the nearest bookstore
                const nearestBookstore = findNearestBookstore(userLocation);
                //set nearest bookstore as destination
                const destinationInput= document.getElementById('destination');
                //display them
                destinationInput.value = nearestBookstore ? nearestBookstore.name:'';

            // Use the Geocoding API to convert coordinates into an address
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ 'location': latLng }, function (results, status) {
                if (status === 'OK' && results[0]) {
                    // Display the address as the source location
                       const sourceInput = document.getElementById('source');
                    
                    // Set the value of the source input to the formatted address
                    sourceInput.value = results[0].formatted_address;

                    // Initialize the map with the user's current location
                    map = new google.maps.Map(document.getElementById('map'), {
                        center: latLng,
                        zoom: 13
                    });

                    //enable the use of scroll wheel
                    google.maps.event.addListener(map,"click",function(event){
                        this.setOptions({scrollwheel:true});
                    })

                    
                    directionsService = new google.maps.DirectionsService();
                    directionsRenderer = new google.maps.DirectionsRenderer();
                    directionsRenderer.setMap(map);

                    sourceAutocomplete= new google.maps.places.Autocomplete(
                        document.getElementById('source')
                    )
                    desAutocomplete = new google.maps.places.Autocomplete(
                        document.getElementById('destination')
                    )

                    marker = new google.maps.Marker({
                        position: latLng,
                        map: map, // Attach the marker to your map
                        title: "Descriptive text", // Optional title for the marker
                        animation:google.maps.Animation.DROP
                    });

                   
                } else {
                    console.error('Geocode was not successful for the following reason: ' + status);
                }
            });
        }, function (error) {
            console.error("Error getting user's location:", error);
        });
    } else {
        alert("Geolocation is not supported by your browser.");
    }





}


function handleMarkerClick() {
    const infowindow = new google.maps.InfoWindow({
      content: '<div>This is the info window content</div>', // Customize the content here
    });
  
    infowindow.open(map, marker);
  }
  

function calRoute(){
    var source = document.getElementById('source').value;
    var dest = document.getElementById('destination').value;

    let request = {
        origin:source,
        destination:dest,
        travelMode:'DRIVING'


    }
    directionsService.route(request,function(result,status){
        if(status == "OK"){
            directionsRenderer.setDirections(result);
            // Remove the old marker
            if (marker) {
                marker.setMap(null);
            }
            
            // Recalculate the nearest bookstore based on the new source location
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ 'address': source }, function (results, status) {
                if (status === 'OK' && results[0]) {
                    const newSourceLocation = {
                        lat: results[0].geometry.location.lat(),
                        lng: results[0].geometry.location.lng()
                    };
                    const nearestBookstore = findNearestBookstore(newSourceLocation);

                    // Update the destination input with the new nearest bookstore
                    const destinationInput = document.getElementById('destination');
                    destinationInput.value = nearestBookstore ? nearestBookstore.name : '';
                } else {
                    console.error('Geocode was not successful for the new source location.');
                }
            });
        }

    })

 
}

function findNearestBookstore(userLocation) {
    let nearestBookstore = null;
    let nearestDistance = Number.MAX_VALUE;
  
    for (const bookstore of bookstores) {
      const bookstoreLocation = bookstore.location;
      const distance = haversine(userLocation, bookstoreLocation);
  
      if (distance < nearestDistance) {
        nearestDistance = distance;
        nearestBookstore = bookstore;
      }
    }
  
    return nearestBookstore;
  }
  
  function haversine(coord1, coord2) {
    const R = 6371; // Earth's radius in km
    const lat1 = coord1.lat;
    const lon1 = coord1.lng;
    const lat2 = coord2.lat;
    const lon2 = coord2.lng;
  
    const dLat = (lat2 - lat1) * (Math.PI / 180);
    const dLon = (lon2 - lon1) * (Math.PI / 180);
  
    const a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(lat1 * (Math.PI / 180)) *
      Math.cos(lat2 * (Math.PI / 180)) *
      Math.sin(dLon / 2) *
      Math.sin(dLon / 2);
  
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  
    return R * c;
  }
  



</script>
</html>